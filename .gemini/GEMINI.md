# Project Aurora-Pi

### **重要: 搭載済みコードの制約**

**本リポジトリのコードは、すでに打ち上げられた衛星に搭載されているため、原則として変更することはできません。**

今後の開発は、衛星から受信したデータを地上で処理するアプリケーションが中心となります。したがって、Gemini との対話やドキュメントの主な目的は、コードの改善案を探ることではなく、**現状の衛星の挙動を正確に理解すること**にあります。なお、地上で受け取ったデータ処理に関する提案や改善については、引き続き歓迎します。

## 1. 概要

Raspberry Pi Zero 搭載の超小型衛星によるオーロラ撮影プロジェクト。
軌道上からオーロラを撮影し、画像を圧縮&テキスト化したデータと、科学的価値を持つ HSV 値データを地上へ送信することを目的とする。

### 1.1. 設計上の制約とステータス管理

通信の制約上、地上局とのアップリンクは衛星の 1 周回につき 1 回が基本となります。そのため、複数周回にまたがるタスクや、予期せぬ再起動から復帰できるよう、現在の処理状況（ステータス）をファイルに永続的に保存する設計になっています。
また、アップリンク経由ではなく、電源系が自動で RPI を起動させる場合もあるため、衛星は起動時にステータスファイルを読み込み、前回の続きから処理を再開します。

## 2. システムアーキテクチャ

### 2.1. 処理フロー

地上局(GS)からの UART コマンド受信を起点として、以下のフローで処理が実行される。

1.  **コマンド受信 (`format/uart_selection_v2_8.py`)**
    - GS からのコマンドを待機し、受信する。
2.  **コマンドに応じた処理実行 (`flow/*.py`)**
    - `CMD_GS_RPI_SHOOTING`: 撮影フローを実行 (`flow/shooting.py`)。
    - `CMD_GS_RPI_ANALYSIS`: 解析フローを実行 (`flow/analysis.py`)。
    - `CMD_GS_RPI_SPLIT`: 画像のテキスト化・分割フローを実行 (`flow/split.py`)。
    - `CMD_GS_RPI_DOWNLINK`: ダウンリンクフローを実行 (`flow/downlink.py`)。

### 2.2. 主要コンポーネント解説

- `src/shooting`: 衛星の経過時間に基づき、カメラでの撮影を実行する。
- `src/analysis`: 撮影された画像を評価し、ダウンリンクに最適な「オーロラ画像」を選定。また、オーロラ部分の平均 HSV 値などを算出しデータとして保存する。
- `src/flow/split.py`: 選定された画像をテキスト化するメインフロー。リサイズ、16 進数文字列への変換、分割を行う。
- `src/downlink`: 要求に応じて、分割された画像テキストやオーロラデータ(HSV)を整形し、送信準備を行う。
- `src/status`: 現在のダウンリンク対象(オーロラデータか画像か)や、次に送信すべきファイルのインデックスなどを記録するテキストファイル群。

## 3. 中核機能の詳細

### 3.1. オーロラ評価ロジック (`analysis/aurora_evaluation.py`)

1.  撮影画像から固定ノイズ画像(`img/noise.jpg`)を減算する。
2.  画像を BGR から HSV 色空間へ変換する。
3.  `constant/analysis.py`で定義された HSV 閾値 (`MIN_HSV_RANGE`, `MAX_HSV_RANGE`) を用いてマスク処理を行い、オーロラピクセルを抽出する。
4.  **評価値**を以下の式で算出する。
    - `評価値 = (オーロラ率) + (オーロラ部分の平均Value値 / 255)`
5.  この評価値が過去最高の場合、その画像をダウンリンク対象として`/img/downlink_img/`に保存する。

### 3.2. 画像のテキスト化・分割 (`analysis/file_generation.py`)

1.  **16 進数文字列化 (`convert_img_into_text`)**:
    - 画像を 1 次元のピクセル配列に変換。
    - 各ピクセル値(0-255)を 2 桁の 16 進数文字列(例: `ff`)に変換し、全て連結する。
2.  **データ分割 (`split_text_string`)**:
    - 生成された 16 進数文字列を、**140 文字**ごとに分割する。
    - 分割された各データに対し、ヘッダーとして**6 桁の 16 進数ファイル番号**を付与する。(例: `000001` + `(140文字のデータ)`)
    - `/data/aurora_img/`ディレクトリ以下に、連番のファイルとして保存する。

### 3.3. UART 通信フォーマット (`format_array`)

衛星内の各コンポーネント間、および地上局との通信は、`format_array`と呼ばれる Python リスト（配列）で標準化されています。全体の構造は `[アドレス, コマンド, データ長, ...データ本体..., CRC(1), CRC(2)]` となります。

| インデックス  | 定数名              | 内容                                                                 |
| :------------ | :------------------ | :------------------------------------------------------------------- |
| 0             | `FORMAT_ADRS`       | **アドレスバイト**。上位 4bit が送信元、下位 4bit が宛先を示します。 |
| 1             | `FORMAT_CMD`        | **コマンドバイト**。実行すべき処理を定義します。                     |
| 2             | `FORMAT_DATA_SIZE`  | **データ長バイト**。後続のデータペイロードのバイト数を示します。     |
| 3...          | `FORMAT_DATA_START` | **データペイロード**。コマンドに付随するデータ本体。可変長です。     |
| 末尾 2 バイト | -                   | **CRC**。データ全体の誤り検出符号(CRC-16)です。                      |

`src/format/format.py`内の関数群が、この配列の生成と解析を担当します。

## 4. GS 受信コマンド体系 (`constant/command_list.py`)

地上局からのコマンドは、コマンドを識別する値に加え、動作を具体化するための引数（ペイロード）を伴うことがあります。

| コマンド名             | 値  | 引数（ペイロード）         | 説明                                                                                                             |
| :--------------------- | :-- | :------------------------- | :--------------------------------------------------------------------------------------------------------------- |
| `CMD_GS_RPI_SHOOTING`  | 2   | なし                       | 撮影フローを開始する                                                                                             |
| `CMD_GS_RPI_SPLIT`     | 3   | なし                       | 画像のテキスト化・分割フローを開始する                                                                           |
| `CMD_GS_RPI_DOWNLINK`  | 4   | `[データ種別, データ詳細]` | ダウンリンクを開始する。引数で指定された内容を`status`ファイルに書き込み、その後のダウンリンク処理で参照させる。 |
| `CMD_GS_RPI_ANALYSIS`  | 5   | `[実行回数]`               | 解析フローを指定された回数実行する。                                                                             |
| `CMD_GS_RPI_TASK_INFO` | 6   | `[タスク情報配列]`         | 撮影や解析のスケジュールといったタスク情報を衛星に書き込む。                                                     |

### `CMD_GS_RPI_DOWNLINK` の引数詳細

`[データ種別]` の値によって、後続の `[データ詳細]` の解釈が変わります。

- **データ種別 `AURORA_DATA`**:
  - データ詳細: なし
  - 動作: 次のダウンリンクをオーロラ(HSV)データに設定する。
- **データ種別 `AURORA_IMG`**:
  - データ詳細: `[画像番号(3 bytes)]`
  - 動作: 指定された単一の画像番号をダウンリンク対象として `/src/status/aurora_img.txt` に書き込む。
- **データ種別 `DESIGNED_AURORA_IMG`**:
  - データ詳細: `[画像番号1(3 bytes), 画像番号2(3 bytes), ...]`
  - 動作: 指定された複数の画像番号をダウンリンク対象リストとして `/src/status/designed_aurora_img.txt` に書き込む。
